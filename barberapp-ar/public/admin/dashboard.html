<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - BarberApp AR</title>
    <link rel="stylesheet" href="/css/styles.css" />
  </head>
  <body>
    <header class="header">
      <div class="container">
        <div class="header-content">
          <a href="/" class="logo">BarberApp AR</a>
          <nav class="nav">
            <a href="/admin/dashboard.html">Dashboard</a>
            <a href="/admin/negocios.html">Mis Negocios</a>
            <a href="/admin/turnos.html">Turnos</a>
            <a href="#" onclick="logout()">Cerrar Sesión</a>
          </nav>
        </div>
      </div>
    </header>

    <main class="container" style="padding: 2rem 0">
      <h1 style="font-size: 2.5rem; margin-bottom: 2rem">Dashboard</h1>

      <div class="grid grid-3" style="margin-bottom: 2rem">
        <div class="card" style="background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); color: white">
          <h3 style="font-size: 1rem; opacity: 0.9; margin-bottom: 0.5rem">Total Negocios</h3>
          <p id="totalNegocios" style="font-size: 2.5rem; font-weight: bold">0</p>
        </div>
        <div class="card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white">
          <h3 style="font-size: 1rem; opacity: 0.9; margin-bottom: 0.5rem">Turnos Hoy</h3>
          <p id="turnosHoy" style="font-size: 2.5rem; font-weight: bold">0</p>
        </div>
        <div class="card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white">
          <h3 style="font-size: 1rem; opacity: 0.9; margin-bottom: 0.5rem">Turnos Pendientes</h3>
          <p id="turnosPendientes" style="font-size: 2.5rem; font-weight: bold">0</p>
        </div>
      </div>

      <div class="grid grid-2">
        <div class="card">
          <h2 class="card-title">Acciones Rápidas</h2>
          <div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem">
            <a href="/admin/negocios.html?action=crear" class="btn btn-primary">Crear Nuevo Negocio</a>
            <a href="/admin/turnos.html" class="btn btn-outline">Ver Todos los Turnos</a>
          </div>
        </div>

        <div class="card">
          <h2 class="card-title">Próximos Turnos</h2>
          <div id="proximosTurnos" style="margin-top: 1rem">
            <div style="text-align: center; padding: 1rem">
              <div class="loading" style="border-color: var(--primary); border-top-color: transparent"></div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script src="/js/auth.js"></script>
    <script>
      requirePropietario()

      async function loadDashboard() {
        try {
          // Cargar negocios
          const negociosRes = await authenticatedFetch("/api/negocios/mis-negocios/lista")
          const negocios = await negociosRes.json()
          document.getElementById("totalNegocios").textContent = negocios.length

          if (negocios.length === 0) {
            document.getElementById("proximosTurnos").innerHTML = `
              <p style="color: var(--text-secondary); text-align: center">
                Crea tu primer negocio para comenzar
              </p>
            `
            return
          }

          // Cargar turnos del primer negocio
          const turnosRes = await authenticatedFetch(`/api/turnos/negocio/${negocios[0].id}`)
          const turnos = await turnosRes.json()

          const today = new Date().toISOString().split("T")[0]
          const turnosHoy = turnos.filter((t) => t.fecha === today)
          const turnosPendientes = turnos.filter((t) => t.estado === "pendiente")

          document.getElementById("turnosHoy").textContent = turnosHoy.length
          document.getElementById("turnosPendientes").textContent = turnosPendientes.length

          // Mostrar próximos turnos
          const proximosTurnos = turnos
            .filter((t) => t.estado !== "cancelado" && t.estado !== "completado")
            .sort((a, b) => new Date(a.fecha + " " + a.hora_inicio) - new Date(b.fecha + " " + b.hora_inicio))
            .slice(0, 5)

          const container = document.getElementById("proximosTurnos")

          if (proximosTurnos.length === 0) {
            container.innerHTML = `
              <p style="color: var(--text-secondary); text-align: center">No hay turnos próximos</p>
            `
            return
          }

          container.innerHTML = proximosTurnos
            .map(
              (turno) => `
            <div style="padding: 0.75rem; border-bottom: 1px solid var(--border)">
              <p style="font-weight: 600; margin-bottom: 0.25rem">${turno.perfiles?.nombre_completo || "Cliente"}</p>
              <p style="color: var(--text-secondary); font-size: 0.875rem">
                ${new Date(turno.fecha).toLocaleDateString("es-AR")} - ${turno.hora_inicio.slice(0, 5)}
              </p>
              <p style="color: var(--text-secondary); font-size: 0.875rem">
                ${turno.servicios?.nombre || "Servicio"}
              </p>
            </div>
          `
            )
            .join("")
        } catch (error) {
          console.error("[v0] Error loading dashboard:", error)
        }
      }

      loadDashboard()
    </script>
  </body>
</html>
